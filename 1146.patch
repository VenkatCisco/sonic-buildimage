From a9da49ba3a4c8f484a02c6bdc48e10e4a15374f8 Mon Sep 17 00:00:00 2001
From: Anand Mehra <anamehra@cisco.com>
Date: Sat, 17 Jul 2021 17:24:19 -0700
Subject: [PATCH 1/3] Adding path check option in template.j2

Signed-off-by: Anand Mehra <anamehra@cisco.com>
---
 Makefile | 37 +++++++++++++++++++++++++------------
 1 file changed, 25 insertions(+), 12 deletions(-)

diff --git a/Makefile b/Makefile
index 52f4e80f4..3b8792bfb 100644
--- a/Makefile
+++ b/Makefile
@@ -13,6 +13,14 @@ ifeq ($(NOSTRETCH),0)
 BUILD_STRETCH=1
 endif
 
+ifeq ($(NOBUSTER),0)
+BUILD_BUSTER=1
+endif
+
+ifeq ($(NOBULLSEYE),0)
+BUILD_BULLSEYE=1
+endif
+
 PLATFORM_PATH := platform/$(if $(PLATFORM),$(PLATFORM),$(CONFIGURED_PLATFORM))
 PLATFORM_CHECKOUT := platform/checkout
 PLATFORM_CHECKOUT_FILE := $(PLATFORM_CHECKOUT)/$(PLATFORM).ini
@@ -60,18 +68,23 @@ init:
 #
 define make_work
 	@echo "+++ Making $@ +++"
-ifeq ($(NOJESSIE), 0)
-	make -f Makefile.work $@
-endif
-ifeq ($(NOSTRETCH), 0)
-	BLDENV=stretch make -f Makefile.work $@
-endif
-ifeq ($(NOBUSTER), 0)
-	BLDENV=buster make -f Makefile.work $@
-endif
-ifeq ($(NOBULLSEYE), 0)
-	BLDENV=bullseye make -f Makefile.work $@
-endif
+	$(if $(BUILD_JESSIE),make -f Makefile.work $@,)
+	$(if $(BUILD_STRETCH),BLDENV=stretch make -f Makefile.work $@,)
+	$(if $(BUILD_BUSTER),BLDENV=buster make -f Makefile.work $@,)
+	$(if $(BUILD_BULLSEYE),BLDENV=bullseye make -f Makefile.work $@,)
+endef
+
+.PHONY: $(PLATFORM_PATH)
+
+$(PLATFORM_PATH):
+	@echo "+++ Cheking $@ +++"
+	$(PLATFORM_CHECKOUT_CMD)
+
+configure : $(PLATFORM_PATH)
+	$(call make_work, $@)
+
+clean reset showtag sonic-slave-build sonic-slave-bash :
+	$(call make_work, $@)
 
 # Freeze the versions, see more detail options: scripts/versions_manager.py freeze -h
 freeze:

From 87c0252e866ef31c88d6833a439f0c1db1988f7d Mon Sep 17 00:00:00 2001
From: Anand Mehra <anamehra@cisco.com>
Date: Sat, 17 Jul 2021 17:35:42 -0700
Subject: [PATCH 2/3] Adding path check option in template.j2

Signed-off-by: Anand Mehra <anamehra@cisco.com>
---
 platform/checkout/template.j2 | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/platform/checkout/template.j2 b/platform/checkout/template.j2
index 4847c82d2..cc0c86c2a 100644
--- a/platform/checkout/template.j2
+++ b/platform/checkout/template.j2
@@ -1,6 +1,11 @@
 {% set path = env('PLATFORM_PATH') %}
+if [ ! -d {{ path }} ]; then git clone {{ module.repo }} {{ path }}; fi;
+if [ -d {{ path }} ]; then cd {{ path }} &&
+
 {% if module.ref is defined %}
-git clone {{ module.repo }} {{ path }} && cd {{ path }} && git checkout {{ module.ref }} && git submodule update --init --recursive
+git checkout {{ module.ref }} && git submodule update --init --recursive;
 {% else %}
-git clone {{ module.repo }} {{ path }} && cd {{ path }} && git submodule update --init --recursive
+git submodule update --init --recursive;
 {% endif %}
+
+else echo "{{ path }} not found"; exit 1; fi

From c23152f48a357546d52be075a4507af04cbdf5db Mon Sep 17 00:00:00 2001
From: Anand Mehra <anamehra@cisco.com>
Date: Sat, 17 Jul 2021 18:01:06 -0700
Subject: [PATCH 3/3] Check for .git path before git update/checkout

Signed-off-by: Anand Mehra <anamehra@cisco.com>
---
 platform/checkout/template.j2 | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/platform/checkout/template.j2 b/platform/checkout/template.j2
index cc0c86c2a..17b8f00c8 100644
--- a/platform/checkout/template.j2
+++ b/platform/checkout/template.j2
@@ -1,6 +1,6 @@
 {% set path = env('PLATFORM_PATH') %}
 if [ ! -d {{ path }} ]; then git clone {{ module.repo }} {{ path }}; fi;
-if [ -d {{ path }} ]; then cd {{ path }} &&
+if [ -d {{ path }}/.git ]; then cd {{ path }} &&
 
 {% if module.ref is defined %}
 git checkout {{ module.ref }} && git submodule update --init --recursive;
@@ -8,4 +8,4 @@ git checkout {{ module.ref }} && git submodule update --init --recursive;
 git submodule update --init --recursive;
 {% endif %}
 
-else echo "{{ path }} not found"; exit 1; fi
+else echo "{{ path }}/.git not found"; exit 1; fi
